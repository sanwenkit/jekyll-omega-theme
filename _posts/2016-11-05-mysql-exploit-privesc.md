---
layout: post
title: mysql本地提权及命令执行调试记录
description: "mysql本地提权及命令执行漏洞调试记录"
category: scanner
tags: [scanner, mysql]
imagefeature: http://7xwdx7.com1.z0.glb.clouddn.com/5551e1cabd3bb.jpg
comments: true
share: true
---

### 概要

对legalhack放出的mysql本地提权及代码执行POC进行测试，记录了相关的步骤、条件及结果。

### 由数据库普通用户提权至数据库root用户权限

首先，创建一个数据库普通用户用于验证该漏洞，下图中创建了一个名为sanwenkit的数据库用户，只有单个数据库的操作权限，无权对mysql进行相关配置。同时，图中可以看到，当前数据库版本为5.5.44

![mysql普通用户权限](http://7xwdx7.com1.z0.glb.clouddn.com/mysql-user-role.jpeg)

编译mysql漏洞利用POC：

{% highlight shell %}

gcc mysql-privesc-race.c -o mysql-privesc-race -I/usr/include/mysql -lmysqlclient

{% endhighlight %}

运行POC：

{% highlight shell %}

./mysql-privesc-race dbuser dbpass dbhost dbname

{% endhighlight %}

等待一段时间后，应该就能拿到mysql root权限的shell了。

![mysql root权限shell](http://7xwdx7.com1.z0.glb.clouddn.com/mysql-cve-2016-6663.jpeg)

看一下当前用户权限，可以看到已经是系统用户mysql的权限了。

![有权限mysql目录](http://7xwdx7.com1.z0.glb.clouddn.com/mysql-whoami.png)

![mysql root权限shell](http://7xwdx7.com1.z0.glb.clouddn.com/mysql-get-root-role.png)


### 由系统用户mysql提升至root权限

下一步，是从系统用户mysql提升至root权限，这里测试发现需要先开启mysql的FILE（文件读写）权限。

相关命令如下：

{% highlight shell %}

GRANT FILE on *.* TO sanwenkit@‘%’;

{% endhighlight %}

随后运行用来提权的python脚本，命令格式如下：

{% highlight shell %}

python mysql-poc.py -dbuser aaa -dbpass 'bbb' -dbhost ccc -dbname ddd -mycnf /path/to/my.cnf

{% endhighlight %}

运行python脚本，如果一切正常的话，会利用netcat打开一个后门监听端口。同时，my.cnf配置文件会被改写，用来在mysql服务重启时进行提权，获取系统root权限。

![监听本地端口](http://7xwdx7.com1.z0.glb.clouddn.com/mysql-listen-netcat.png)

![改写配置文件](http://7xwdx7.com1.z0.glb.clouddn.com/mysql-config-file-rewrite.png)
